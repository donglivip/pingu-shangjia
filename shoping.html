<!DOCTYPE html>
<html>

	<head>
		<meta charset="UTF-8">
		<title></title>
		<meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no" />
		<link rel="stylesheet" type="text/css" href="css/shoping.css" />
		<link rel="stylesheet" href="css/wangEditor-mobile.css" />
		<script src="js/rem.js" type="text/javascript" charset="utf-8"></script>
		<link rel="stylesheet" href="css/mui.css" />
		<script src="js/mui.min.js"></script>
		<style>
			.banner-txt {
				color: #666;
				padding: 0.24rem;
			}
			
			.wangEditor-mobile-txt {
				border: 1px solid gainsboro;
			}
			
			select {
				width: 2rem !important;
				padding: 0 0 !important;
				/*padding-right: 0.24rem;*/
				text-align: center;
				text-align-last: center;
				margin-bottom: 0 !important;
			}
			
			input {
				font-size: 0.26rem;
				line-height: 0.2rem;
				height: 0.6rem !important;
				border: 0 !important;
				margin-bottom: 0 !important;
				background: none !important;
				outline: 0;
				padding: 0 !important;
			}
			
			#zhe {
				width: 3rem !important;
				text-align: center;
			}
		</style>
	</head>

	<body>
		<div class="wrapper">
			<div class="header">
				<div class="heade-aside mui-action-back">
					<img src="img/youjian.png" />
				</div>
				<div class="hedaer-center">
					发布商品
				</div>
				<div class="heade-aside">

				</div>
			</div>
			<div class="main">
				<div class="shop-box">
					<div class="shop-top">
						<span><strong>* </strong>标题</span>
						<span class="title-length">0/60</span>
					</div>
					<textarea class="title" placeholder="请输入商品标题" maxlength="60"></textarea>
					<div class="img-box">
						<img src="img/upload.png" id="itemImg" />
					</div>
					<p class="banner-txt">请输入商品简介</p>
					<textarea id="textarea1" style="width:100%;height:100%;border: 1px solid gainsboro;" value="请输入商品简介">

                    </textarea>
				</div>
				<div class="shop-box">
					<div class="input-box">
						<label for="">规格</label>
					</div>
					<!--<div class="input-box">
						<label for="" style="flex: 1;"> <small>规格类型</small>尺寸</label>
						<img src="img/you-hui.png" />
					</div>-->
					<div class="gui-box specWrap">
						<div class="gui-tab">
							<div class="gui-title">
								名称
							</div>
							<input type="text" placeholder="请输入名称" />
						</div>
						<div class="gui-tab">
							<div class="gui-title">
								单价
							</div>
							<input type="text" placeholder="请输入单价" />
						</div>
					</div>
					<div class="gui-add specAdd">
						<img src="img/add.png" /> 添加规格
					</div>
				</div>
				<div class="shop-box">
					<div class="input-box">
						<label for="">参数</label>
					</div>
					<!--<div class="input-box">
						<label for="" style="flex: 1;"> <small>规格类型</small>尺寸</label>
						<img src="img/you-hui.png" />
					</div>-->
					<div class="gui-box parameter">
						<div class="gui-tab">
							<div class="gui-title">
								品牌
							</div>
							<input type="text" class="val" placeholder="请输入品牌" />
						</div>
						<!--<div class="gui-tab">
							<div class="gui-title">
								颜色
							</div>
							<input type="text" class="val" placeholder="请输入颜色" />
						</div>-->

					</div>
					<div class="gui-add parameterBtn">
						<img src="img/add.png" /> 添加参数
					</div>
				</div>
				<div class="shop-box">
					<div class="input-box">
						<label for="">价格和库存</label>
					</div>
					<div class="input-box" style="display: flex;justify-content: space-between;">
						<label for="">价格</label>
						<input type="text" id="price" placeholder="请输入默认价格" style="padding-left: 1rem;width: 4.2rem;" />
					</div>
					<div class="input-box" style="display: flex;justify-content: space-between;">
						<label for="">库存</label>
						<input type="text" id="stock" placeholder="请输入库存" style="padding-left: 1rem;width: 4.2rem;" />
					</div>
					<div class="input-box">
						<label for="">分类</label>
						<select name="CommType" id="TypeOne">

						</select>
					</div>

				</div>
				<div class="btn">
					创建
				</div>
			</div>
		</div>

		<script src="js/jquery-2.1.0.js"></script>
		<script src="js/zepto.js"></script>
		<script src="js/zepto.touch.js"></script>
		<script src="js/url.js"></script>
		<script src="js/wangEditor-mobile.js"></script>
		
		<script src="js/upload.js"></script>
		<script type="text/javascript">
			//判断是否 设置运费模版  
			var smMerchantId = localStorage.getItem('smMerchantId');
			$.ajax({
				type: "post",
				url: url_url + '/merchant/queryExpressCount',
				async: true,
				data: {
					smMerchantId: smMerchantId
				},
				success: function(res) {
					if(!res.data) {
						mui.alert('请先设置运费模板', function() {
							mui.openWindow('freight.html')
						})
					}
				},
				error: function(err) {

				}
			});
			// 
			// 获取分类
			$.ajax({
				type: "post",
				url: url_url + "/merchant/querySmCommodityType",
				async: true,
				data: {
					'smMerchantId': smMerchantId
				},
				success: function(res) {
					var typeHtml = ''
					if(res.data.length == 0 || res.data == null) {
						alert('请先添加分类')
					} else {
						for(i in res.data) {
							typeHtml +=
								`
						     <option value=${res.data[i].smCommodityTypeId}>${res.data[i].smCtResult}</option>
						`;
						}
						$('#TypeOne').append(typeHtml)
					}

				},
				error: function(err) {

				}
			});

			$(function() {
				$('.title').on('keyup', function() {
					$('.title-length').text($(this).val().length + '/60');
				});
				//               富文本初始化
				var editor = new ___E('textarea1');
				editor.init();
				editor.config.uploadImgUrl = url_url + '/merchant/uploads';
				
				$('.specAdd').click(function() {
					var guiList =
						`
					<div class="gui-tab">
							<div class="gui-title">
								名称
							</div>
							<input type="text" placeholder="请输入名称" />
						</div>
						<div class="gui-tab">
							<div class="gui-title">
								单价
							</div>
							<input type="text" placeholder="请输入单价" />
						</div>
					`;

					$('.specWrap').append(guiList);
				});

				$('.parameterBtn').click(function() {
					var guiList =
						`
					<div class="gui-tab">
							<div class="gui-title2">
								<input type="text" class="paraKey" placeholder="输入参数" />
							</div>
							<input type="text" class="val" placeholder="请输入参数值" />
						</div>
						
					`;

					$('.parameter').append(guiList);
				})

				$('#itemImg').on('click', function() {
					$(this).upload('/merchant/insertCommodityImage');
				});
				$('#bannerImg').on('click', function() {
					$(this).upload('/merchant/insertCommodityImage');
				});

				//  添加商品
				$('.btn').click(function() {

					var smMerchantId = localStorage.getItem('smMerchantId');
					//规格
					var numArr = new Array();
					var flag = true;
					$('.specWrap input').each(function() {
						if($(this).val() == '') {
							flag = false;
							alert('请将规格输入完整');
							return false
						} else {
							flag = true;
							numArr.push($(this).val()); //添加至数组
						}
					});

					if(!flag) {
						return false;
					}
					var guige = {}
					for(var i in numArr) {
						if(i % 2 == 0) {
							var key = numArr[i]
							var value = numArr[parseInt(i) + 1]
							guige[key] = value;
						}
					}
					console.log(guige)
					//参数
					var keyArr = new Array();
					var valArr = new Array();
					$('.parameter .gui-title').each(function() {
						if($(this).text().trim() == '') {
							flag = false;
							alert('请将参数输入完整');
							return false
						} else {
							flag = true;
							keyArr.push($(this).text().trim())
						}

					});
					if(!flag) {
						return false;
					}

					$('.parameter .paraKey').each(function() {
						if($(this).val() == '') {
							flag = false;
							alert('请将参数输入完整');
							return false
						} else {
							flag = true;
							keyArr.push($(this).val())
						}

					});
					if(!flag) {
						return false;
					}
					$('.parameter .val').each(function() {
						if($(this).val() == '') {
							flag = false;
							alert('请将参数输入完整');
							return false
						} else {
							flag = true;
							valArr.push($(this).val())
						}

					});
					var canshu = {}
					for(var i in keyArr) {
						var key = keyArr[i]
						var value = valArr[i]
						canshu[key] = value;
					}

					console.log(canshu)
					if(!flag) {
						return false;
					}
					console.log(JSON.stringify(canshu))
					var DefaultImg = $('#itemImg').attr('src');
					var smCoDefaultImg = null;
					if(DefaultImg == 'img/upload.png') {
						flag = false;
						alert('请上传默认图片')
					} else {
						smCoDefaultImg = DefaultImg;
					}
					if(!flag) {
						return false;
					}
					var smCommodityTypeId = $('#TypeOne').val();
					if(smCommodityTypeId == '') {
						flag = false;
						alert('请选择分类');
					}
					if(!flag) {
						return false;
					}
					var smCoDefaultPrice = $('#price').val()
					if(smCoDefaultPrice == '') {
						flag = false;
						alert('请输入默认价格');
					}
					if(!flag) {
						return false;
					}
					var smCoStock = $('#stock').val();
					if(smCoStock == '') {
						flag = false;
						alert('请输入库存');
					}
					if(!flag) {
						return false;
					}
					if(!flag) {
						return false;
					}
					var smCoName = $('.title').val();
					if(smCoName == '') {
						flag = false;
						alert('请输入标题');
					}
					if(!flag) {
						return false;
					}
					//富文本 内容
					var $txt = editor.$txt;
					var smCoResult = $txt.html()

					var smCoCreateName = localStorage.getItem('smMeCreateName')
					var smMerchantId = localStorage.getItem('smMerchantId')

					var smCoIsBanner = null;
					var smCoBannerImg = null;

					if($('#bannerImg').attr('src') == 'img/upload.png') {
						smCoIsBanner = 2
						smCoBannerImg = '';
					} else {
						smCoIsBanner = 1
						smCoBannerImg = $('#bannerImg').attr('src')
					}
					$.ajax({
						type: "post",
						url: url_url + "/merchant/insertCommodity",
						async: true,
						data: {
							smCommodityTypeId: smCommodityTypeId,
							smCoFarmat: JSON.stringify(guige),
							smCoParameter: JSON.stringify(canshu),
							smCoName: smCoName,
							smCoDefaultPrice: smCoDefaultPrice,
							smCoIsDiscount: 2,
							smCoStock: smCoStock,
							smCoSalesVolume: 0,
							smCoEvaluateGrade: 5,
							smCoIsFreeShipping: 1,
							smCoIsShelf: 1,
							smMerchantId: smMerchantId,
							smCoCreateName: smMerchantId,
							smCoDefaultImg: smCoDefaultImg,
							smCoResult: smCoResult
						},
						success: function(res) {
							if(res.status == 200) {
								mui.toast('添加成功')
								mui.back()
							} else {
								alert(res.msg)
							}
						},
						error: function(err) {
							alert(JSON.stringify(err))
						}
					});

				})

			})
		</script>
	</body>

</html>